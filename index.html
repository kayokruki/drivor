<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Katalis ‚Äî Gerenciador Completo</title>
  <meta name="description" content="Katalis: controle de receitas, despesas, gest√£o de estoque, RH e tarefas para pequenas empresas" />
  
  <link rel="icon" href="images/favicons/katalis-favicon-16x16.png" sizes="16x16" type="image/png">
  <link rel="icon" href="images/favicons/katalis-favicon-32x32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="images/favicons/katalis-favicon-48x48.png" sizes="48x48" type="image/png">
  <link rel="icon" href="images/favicons/katalis-favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="images/favicons/katalis-apple-touch-icon.png">
  <link rel="manifest" href="images/favicons/site.webmanifest">
  
  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#6b7280; 
      --accent:#1d1d1d; /* COR PRINCIPAL (Preto) */
      --danger:#dc2626; 
      --success:#16a34a; /* VERDE de Receita/Sucesso */
      --radius:12px; --gap:16px; --maxw:1100px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: light;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#eef2f7); padding:32px; display:flex; justify-content:center; font-size:16px;
      -webkit-font-smoothing:antialiased; -moz-osx-smoothing:grayscale;
    }
    .container{width:100%; max-width:var(--maxw)}

    header{display:flex; align-items:center; gap:16px; margin-bottom:20px}
    .logo{display:flex; align-items:center; gap:12px}
    .brand{font-weight:700; font-size:20px}
    .subtitle{color:var(--muted); font-size:13px}

    /* ESTILOS DAS ABAS (TABS) */
    .tabs{margin-bottom:20px; border-bottom:1px solid #eef2f6;}
    .tabs-nav{display:flex; gap:20px;}
    .tab-link{
      padding: 10px 0;
      color: var(--muted);
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: color 0.2s;
      position: relative; 
    }
    .tab-link:hover{
        color: var(--accent);
    }
    .tab-link.active{
        color: var(--accent);
        border-bottom-color: var(--success); 
        font-weight: 700;
    }
    .tab-content{
        padding-top: 10px; 
    }
    /* Notifica√ß√£o da aba RH */
    .notification-badge {
        position: absolute;
        top: 0px;
        right: -10px;
        background-color: var(--danger);
        color: white;
        font-size: 10px;
        font-weight: bold;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: none; 
        align-items: center;
        justify-content: center;
        z-index: 10;
        border: 2px solid var(--card); 
    }
    .notification-badge.active {
        display: flex;
    }

    /* Conte√∫do do Dashboard, Estoque e RH */
    .grid{display:grid; grid-template-columns:1fr 360px; gap:var(--gap)}
    .card{background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:0 6px 20px rgba(2,6,23,0.06)}

    /* Dashboard */
    .balances{display:flex; gap:12px; margin-bottom:16px}
    .balance{flex:1; padding:14px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#fbfdfe); min-height:68px;
        display: flex; flex-direction: column; justify-content: center; 
    }
    .bal-title{font-size:12px; color:var(--muted)}
    .bal-value{font-weight:700; font-size:20px}
    
    /* Corre√ß√£o de Altura do Gr√°fico: Solu√ß√£o Definitiva */
    .chart-wrapper{
      height: 240px; 
      margin-left: -18px;
      margin-right: -18px;
      padding: 0 18px 18px 18px; 
      margin-bottom: 20px; 
      display: flex;
      flex-direction: column;
    }
    #summaryChart{
      height: 100% !important; 
      width: 100% !important;
    }

    /* Transa√ß√µes Isoladas */
    .transactions-wrapper{
        margin-top: 16px; 
    }

    /* Form */
    label{display:block; font-size:13px; margin-bottom:8px}
    input[type="text"], input[type="number"], select, textarea, input[type="date"]{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ee; font-size:14px;
    }
    .row{display:flex; gap:12px}
    .row .col{flex:1}
    .actions{display:flex; gap:10px; margin-top:10px}
    button{background:var(--accent); color:white; border:0; padding:10px 12px; border-radius:8px; cursor:pointer}
    button.secondary{background:transparent; color:var(--accent); border:1px solid rgba(29, 29, 29, 0.18)}
    button.danger{background:var(--danger)}
    
    /* Bot√µes Espec√≠ficos */
    .stock-action-btn{ background-color: var(--success); }
    .stock-action-btn:hover{ background-color: #118d3e; } 

    .rh-action-btn{ background-color: #2563eb; } /* Um azul para RH */
    .rh-action-btn:hover{ background-color: #1e40af; }
    
    .payment-fulfilled-btn{ background-color: var(--success); padding: 6px 10px; font-size: 13px; }

    .todo-item-btn{ background-color: #5c626f; } /* Um cinza para Tarefas */
    .todo-item-btn:hover{ background-color: #3b424e; }
    
    /* Transactions & Stock Table */
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; text-align:left; border-bottom:1px solid #eef2f6}
    th{font-weight:600; font-size:13px; color:var(--muted)}
    
    .amount{font-weight:700}
    .credit{color:var(--success)} 
    .debit{color:var(--danger)}
    .low-stock{color:var(--danger); font-weight: 600;} 
    .stock-total-value{font-weight: 700; color: var(--accent);} 
    
    /* Lista de Tarefas (To-Do List) */
    .todo-list {
        list-style: none;
        padding: 0;
        margin-top: 16px;
    }
    .todo-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eef2f6;
    }
    .todo-list li:last-child {
        border-bottom: none;
    }
    .todo-text {
        flex-grow: 1;
        margin-right: 10px;
    }
    .todo-done .todo-text {
        text-decoration: line-through;
        color: var(--muted);
    }
    .todo-actions button {
        background: transparent;
        color: var(--muted);
        border: none;
        padding: 4px;
        font-size: 14px;
        cursor: pointer;
    }
    .todo-actions .complete-btn {
        color: var(--success);
    }
    .todo-actions .remove-btn {
        color: var(--danger);
        margin-left: 8px;
    }

    /* Small screens */
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
      .balances{ flex-direction:column; gap: 8px; }
      .balance{ padding: 12px; }
      .chart-wrapper{ margin-left: 0; margin-right: 0; padding: 0 0 18px 0; }
      table:not(.responsive-table-ignore) { border: 0; font-size: 15px; }
      table:not(.responsive-table-ignore) thead{ border: none; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; width: 1px; }
      table:not(.responsive-table-ignore) tr{ display: block; margin-bottom: 12px; border: 1px solid #eef2f6; border-radius: var(--radius); padding: 8px 12px; box-shadow: 0 1px 4px rgba(2,6,23,0.04); }
      table:not(.responsive-table-ignore) td{ display: block; border-bottom: 1px solid #eef2f6; text-align: right; padding: 6px 0; }
      table:not(.responsive-table-ignore) tr:last-child { margin-bottom: 0; }
      table:not(.responsive-table-ignore) td:last-child{ border-bottom: 0; text-align: left; padding-top: 10px; }
      table:not(.responsive-table-ignore) td::before{ content: attr(data-label); float: left; font-weight: bold; color: var(--muted); margin-right: 8px; }
      table:not(.responsive-table-ignore) td:last-child button { width: 100%; background-color: var(--danger); }
      .transactions-wrapper > div[style*="overflow:auto"], #stock-content div[style*="overflow:auto"], #rh-content div[style*="overflow:auto"]{ overflow: visible !important; padding: 0 !important; max-height: none !important; }
      #txTable td:last-child button { background-color: var(--accent); }

      /* Ajuste para RH em telas menores */
      #employeeTable td:last-child {
        display: flex;
        flex-direction: column;
        gap: 5px;
        align-items: stretch;
      }
    }

    /* a11y focus */
    :focus{outline:3px solid rgba(29, 29, 29, 0.18); outline-offset:2px}

    /* Help text */
    .help{font-size:13px; color:var(--muted)}
    .compact{font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg width="44" height="44" viewBox="0 0 44 44" fill="none" aria-hidden="true" focusable="false">
            <rect width="44" height="44" rx="8" fill="#1d1d1d"/> 
            <rect x="12" y="10" width="4" height="24" rx="2" fill="#fff" />
            <path d="M19 14 L30 25 L19 36" stroke="#16a34a" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
        <div>
          <div class="brand">Katalis</div> 
          <div class="subtitle">Controle financeiro simples para pequenas empresas</div>
        </div>
      </div>
      <div style="margin-left:auto; display:flex; align-items:center; gap:12px">
        <button id="exportBtn" class="secondary" aria-label="Exportar dados">Exportar CSV</button>
        <button id="helpBtn" class="secondary" aria-label="Ajuda">Ajuda</button>
      </div>
    </header>

    <nav class="tabs" role="tablist">
        <div class="tabs-nav">
            <a class="tab-link active" id="tab-dashboard" data-tab-id="dashboard" role="tab" aria-controls="dashboard-content" aria-selected="true">
                Dashboard
            </a>
            <a class="tab-link" id="tab-stock" data-tab-id="stock" role="tab" aria-controls="stock-content" aria-selected="false">
                Estoque
            </a>
            <a class="tab-link" id="tab-rh" data-tab-id="rh" role="tab" aria-controls="rh-content" aria-selected="false">
                RH 
                <span id="rh-notification-badge" class="notification-badge" aria-label="Aviso de pagamento pendente">1</span>
            </a>
            <a class="tab-link" id="tab-todo" data-tab-id="todo" role="tab" aria-controls="todo-content" aria-selected="false">
                Tarefas
            </a>
        </div>
    </nav>

    <main class="tab-content" role="main">
        <section id="dashboard-content" data-tab-content="dashboard" class="tab-pane">
            <div class="grid">
                <section class="card" aria-labelledby="dashboardTitle">
                    <h2 id="dashboardTitle">Vis√£o geral</h2>
                    <p class="help">Insira receitas e despesas pela direita. Os valores s√£o guardados no navegador (localStorage).</p>

                    <div class="balances" style="margin-top:12px">
                        <div class="balance" aria-live="polite">
                            <div class="bal-title">Saldo</div>
                            <div id="saldo" class="bal-value">R$ 0,00</div>
                        </div>
                        <div class="balance">
                            <div class="bal-title">Receitas (√∫ltimos 30 dias)</div>
                            <div id="receitas" class="bal-value">R$ 0,00</div>
                        </div>
                        <div class="balance">
                            <div class="bal-title">Despesas (√∫ltimos 30 dias)</div>
                            <div id="despesas" class="bal-value">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="chart-wrapper">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding: 0 18px;">
                            <h3 class="compact">Resumo financeiro</h3>
                            <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <rect width="24" height="24" rx="4" fill="#1d1d1d"></rect> 
                                <path d="M6 14l3-3 2 2 6-6" stroke="#16a34a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                            </svg>
                        </div>
                        <canvas id="summaryChart" aria-label="Gr√°fico de receitas e despesas" role="img"></canvas>
                    </div>

                    <div class="transactions-wrapper">
                        <h3 class="compact">√öltimas transa√ß√µes</h3>
                        <div style="overflow:auto; max-height:260px; margin-top:8px">
                            <table id="txTable" aria-live="polite">
                                <thead>
                                    <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th></th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <aside class="card" aria-labelledby="formTitle">
                    <h2 id="formTitle">Adicionar transa√ß√£o</h2>
                    <form id="txForm">
                        <label for="type">Tipo</label>
                        <select id="type" required aria-required="true">
                            <option value="credit">Receita</option>
                            <option value="debit">Despesa</option>
                        </select>

                        <label for="date">Data</label>
                        <input type="date" id="date" required />

                        <label for="desc">Descri√ß√£o</label>
                        <input type="text" id="desc" placeholder="Ex: Venda, aluguel, compra de insumos" required />

                        <label for="category">Categoria</label>
                        <input type="text" id="category" placeholder="Ex: vendas, aluguel, suprimentos" />

                        <label for="amount">Valor (R$)</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" required />

                        <div class="actions">
                            <button type="submit" aria-label="Salvar transa√ß√£o">Salvar</button>
                            <button type="button" id="clearBtn" class="secondary">Limpar</button>
                        </div>
                    </form>

                    <hr style="margin:14px 0" />

                    <div>
                        <h3 class="compact">Importante</h3>
                        <p class="help">Use categorias simples e descreva as transa√ß√µes claramente. Para exportar os dados, clique em "Exportar CSV".</p>
                        <p class="help" style="margin-top:8px">Os dados ficam apenas no seu navegador. Para backup, exporte o CSV regularmente.</p>
                    </div>
                </aside>
            </div>
        </section>

        <section id="stock-content" data-tab-content="stock" class="tab-pane" style="display:none;">
            <div class="grid">
                <section class="card" aria-labelledby="stockListTitle">
                    <h2 id="stockListTitle">Itens em Estoque</h2>
                    
                    <input type="text" id="stockFilter" placeholder="Filtrar por c√≥digo, nome ou categoria..." style="margin-bottom: 12px;" />
                    
                    <div id="stockRiskAlerts">
                    </div>
                    
                    <p class="help" style="margin-top: 12px;">Gerencie o seu invent√°rio de produtos. O estoque √© salvo no navegador (localStorage).</p>
                    
                    <div style="overflow:auto; margin-top:16px">
                        <table id="stockTable" aria-live="polite">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Produto</th>
                                    <th>Categoria</th>
                                    <th>Qtde</th>
                                    <th>Vlr Unit√°rio</th>
                                    <th>Vlr Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <aside class="card" aria-labelledby="stockFormTitle">
                    <h2 id="stockFormTitle">Adicionar/Atualizar Item</h2>
                    <form id="stockForm">
                        <label for="stockCode">C√≥digo do Produto</label>
                        <input type="text" id="stockCode" placeholder="Ex: A001" required />

                        <label for="stockName">Nome do Produto</label>
                        <input type="text" id="stockName" placeholder="Ex: Camiseta P" required />

                        <label for="stockCategory">Categoria</label>
                        <input type="text" id="stockCategory" placeholder="Ex: Roupas, Eletr√¥nicos, Servi√ßos" />

                        <label for="stockPrice">Valor Unit√°rio (R$)</label>
                        <input type="number" id="stockPrice" step="0.01" min="0" placeholder="0.00" required />

                        <label for="stockQuantity">Quantidade</label>
                        <input type="number" id="stockQuantity" min="0" placeholder="0" required />

                        <div class="actions">
                            <button type="submit" class="stock-action-btn" aria-label="Salvar item">Salvar Item</button>
                            <button type="button" id="clearStockBtn" class="secondary">Limpar</button>
                        </div>
                    </form>

                    <hr style="margin:14px 0" />

                    <div>
                        <h3 class="compact">Dicas</h3>
                        <p class="help">Use um c√≥digo √∫nico para cada produto. Mantenha a quantidade atualizada para um controle preciso.</p>
                        <p class="help" style="margin-top:8px">Produtos com quantidade **menor que 5** ser√£o destacados em vermelho.</p>
                    </div>
                </aside>
            </div>
        </section>

        <section id="rh-content" data-tab-content="rh" class="tab-pane" style="display:none;">
            <div class="grid">
                <section class="card" aria-labelledby="employeesListTitle">
                    <h2 id="employeesListTitle">Funcion√°rios Cadastrados</h2>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 class="compact">Pr√≥ximo Pagamento Agendado: <span id="paymentDateDisplay" style="font-weight: 700;">N/A</span></h3>
                        <button id="setPaymentDateBtn" class="rh-action-btn" aria-label="Agendar pr√≥ximo pagamento">Agendar Pagamento</button>
                    </div>

                    <div style="overflow:auto; margin-top:16px">
                        <table id="employeeTable" aria-live="polite">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Cargo</th>
                                    <th>Sal√°rio</th>
                                    <th>Pagamento Cumprido</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody"></tbody>
                        </table>
                    </div>
                </section>

                <aside class="card" aria-labelledby="employeeFormTitle">
                    <h2 id="employeeFormTitle">Cadastrar Funcion√°rio</h2>
                    <form id="employeeForm">
                        <label for="empName">Nome do Funcion√°rio</label>
                        <input type="text" id="empName" placeholder="Nome Completo" required />

                        <label for="empRole">Cargo</label>
                        <select id="empRole" required>
                            <option value="Gerente">Gerente</option>
                            <option value="Auxiliar">Auxiliar</option>
                            <option value="Vendedor">Vendedor</option>
                            <option value="Estagi√°rio">Estagi√°rio</option>
                            <option value="Outro">Outro</option>
                        </select>

                        <label for="empSalary">Sal√°rio (R$)</label>
                        <input type="number" id="empSalary" step="0.01" min="0" placeholder="0.00" required />

                        <div class="actions">
                            <button type="submit" class="rh-action-btn" aria-label="Salvar funcion√°rio">Salvar Funcion√°rio</button>
                            <button type="button" id="clearEmpBtn" class="secondary">Limpar</button>
                        </div>
                    </form>

                    <hr style="margin:14px 0" />

                    <div>
                        <h3 class="compact">Notifica√ß√£o de Pagamento</h3>
                        <p class="help">A "bolinha vermelha" na aba RH aparece na data agendada para lembr√°-lo do pagamento. Marque como "CUMPRIDO" para limpar o alerta.</p>
                    </div>
                </aside>
            </div>
        </section>

        <section id="todo-content" data-tab-content="todo" class="tab-pane" style="display:none;">
            <div class="grid" style="grid-template-columns: 1fr;">
                <section class="card" aria-labelledby="todoListTitle">
                    <h2 id="todoListTitle">Minhas Tarefas do Dia</h2>
                    <p class="help">Liste aqui as tarefas importantes do seu dia-a-dia na gest√£o do neg√≥cio.</p>
                    
                    <ul id="todoList" class="todo-list">
                        </ul>
                </section>
                
                <aside class="card" aria-labelledby="todoFormTitle">
                    <h2 id="todoFormTitle">Adicionar Nova Tarefa</h2>
                    <form id="todoForm">
                        <label for="todoText">Descri√ß√£o da Tarefa</label>
                        <input type="text" id="todoText" placeholder="Ex: Pagar boleto da internet" required />
                        
                        <div class="actions">
                            <button type="submit" class="todo-item-btn" aria-label="Adicionar tarefa">Adicionar Tarefa</button>
                            <button type="button" id="clearTodoBtn" class="secondary">Limpar</button>
                        </div>
                    </form>
                </aside>
            </div>
        </section>

    </main>
    <div id="helpModal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background-color: rgba(0,0,0,0.2);">
      <div class="card" style="width:95%; max-width:720px; box-shadow:0 10px 40px rgba(3,7,18,0.2)">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3>Ajuda ‚Äî Como usar</h3>
          <button id="closeHelp" class="secondary">Fechar</button>
        </div>
        <div style="margin-top:8px">
          <ol>
            <li>Adicione <strong>Receita</strong> ou <strong>Despesa</strong> com data, descri√ß√£o e valor.</li>
            <li>O saldo √© calculado automaticamente. Use categorias para filtrar em futuras vers√µes.</li>
            <li>Exportar CSV salva um arquivo que pode ser aberto no Excel ou Google Sheets.</li>
          </ol>
        </div>
      </div>
    </div>

    <div id="paymentModal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background-color: rgba(0,0,0,0.2);">
        <div class="card" style="width:95%; max-width:400px; box-shadow:0 10px 40px rgba(3,7,18,0.2)">
            <h3>Agendar Pr√≥ximo Pagamento</h3>
            <p class="help">Selecione a data em que o pagamento dos sal√°rios deve ser realizado. Isso ativar√° o alerta na aba RH.</p>
            <form id="paymentDateForm" style="margin-top: 15px;">
                <label for="scheduledPaymentDate">Data de Vencimento</label>
                <input type="date" id="scheduledPaymentDate" required />
                <div class="actions" style="margin-top: 15px;">
                    <button type="submit" class="rh-action-btn">Salvar Data</button>
                    <button type="button" id="closePaymentModal" class="secondary">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
  <script>
    moment.locale('pt-br'); 
    
    // --- Utilit√°rios ---
    const $ = selector => document.querySelector(selector);
    const qs = selector => document.querySelectorAll(selector);

    // CHAVES DE LOCALSTORAGE
    const SALTO_KEY = 'drivor_tx_v1';
    const STOCK_KEY = 'katalis_stock_v1'; 
    const EMP_KEY = 'katalis_emp_v1'; 
    const PAY_KEY = 'katalis_pay_date_v1'; 
    const TODO_KEY = 'katalis_todo_v1'; // NOVA CHAVE TAREFAS

    // ELEMENTOS COMUNS
    const dateEl = $('#date');
    
    // RH
    const employeeForm = $('#employeeForm');
    const empNameEl = $('#empName');
    const empRoleEl = $('#empRole');
    const empSalaryEl = $('#empSalary');
    const employeeTableBody = $('#employeeTableBody');
    const rhBadge = $('#rh-notification-badge');
    const paymentDateDisplay = $('#paymentDateDisplay'); 
    const paymentModal = $('#paymentModal'); 
    const paymentDateForm = $('#paymentDateForm');
    const scheduledPaymentDateEl = $('#scheduledPaymentDate');

    // TAREFAS
    const todoForm = $('#todoForm');
    const todoTextEl = $('#todoText');
    const todoListEl = $('#todoList');


    // ------------------------------------
    // L√ìGICA DE TAREFAS (CRUD)
    // ------------------------------------

    function loadTodos(){
        try{
            const raw = localStorage.getItem(TODO_KEY);
            return raw ? JSON.parse(raw) : [];
        }catch(e){
            console.error('Erro ao carregar tarefas', e);
            return [];
        }
    }
    function saveTodos(list){
        localStorage.setItem(TODO_KEY, JSON.stringify(list));
    }

    todoForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const text = todoTextEl.value.trim();
        if (text) {
            const newTodo = {
                id: Date.now(),
                text: text,
                done: false
            };
            const list = loadTodos();
            list.push(newTodo);
            saveTodos(list);
            todoForm.reset();
            renderTodo();
        }
    });

    $('#clearTodoBtn').addEventListener('click', () => todoForm.reset());

    function toggleTodo(id) {
        const list = loadTodos();
        const index = list.findIndex(t => t.id === id);
        if (index > -1) {
            list[index].done = !list[index].done;
            saveTodos(list);
            renderTodo();
        }
    }

    function removeTodo(id) {
        if (confirm("Deseja remover esta tarefa?")) {
            const list = loadTodos().filter(t => t.id !== id);
            saveTodos(list);
            renderTodo();
        }
    }

    function renderTodo() {
        const list = loadTodos();
        todoListEl.innerHTML = '';

        if (list.length === 0) {
            todoListEl.innerHTML = '<li style="justify-content:center; color:var(--muted); border-bottom: none;">Nenhuma tarefa pendente.</li>';
            return;
        }

        // Ordena: Pendentes primeiro, depois Conclu√≠das
        const sortedList = list.sort((a, b) => (a.done === b.done) ? 0 : a.done ? 1 : -1);

        for (const todo of sortedList) {
            const li = document.createElement('li');
            li.className = todo.done ? 'todo-done' : '';
            li.innerHTML = `
                <span class="todo-text">${escapeHtml(todo.text)}</span>
                <div class="todo-actions">
                    <button class="complete-btn" data-id="${todo.id}" aria-label="${todo.done ? 'Marcar como pendente' : 'Marcar como conclu√≠da'}">
                        ${todo.done ? '‚Ü©Ô∏è' : '‚úÖ'}
                    </button>
                    <button class="remove-btn" data-id="${todo.id}" aria-label="Remover tarefa">üóëÔ∏è</button>
                </div>
            `;
            
            li.querySelector('.complete-btn').addEventListener('click', (e) => toggleTodo(Number(e.currentTarget.dataset.id)));
            li.querySelector('.remove-btn').addEventListener('click', (e) => removeTodo(Number(e.currentTarget.dataset.id)));
            
            todoListEl.appendChild(li);
        }
    }


    // ------------------------------------
    // L√ìGICA DE RH (MANTIDA)
    // ------------------------------------

    function loadEmployees(){
        try{
            const raw = localStorage.getItem(EMP_KEY);
            return raw ? JSON.parse(raw) : [];
        }catch(e){
            console.error('Erro ao carregar funcion√°rios', e);
            return [];
        }
    }
    function saveEmployees(list){
        localStorage.setItem(EMP_KEY, JSON.stringify(list));
    }

    function loadPaymentDate() {
        return localStorage.getItem(PAY_KEY);
    }
    function savePaymentDate(date) {
        localStorage.setItem(PAY_KEY, date);
    }
    function clearPaymentDate() {
        localStorage.removeItem(PAY_KEY);
    }

    employeeForm.addEventListener('submit', (ev)=>{
        ev.preventDefault();
        const newEmployee = {
            id: Date.now(),
            name: empNameEl.value.trim(),
            role: empRoleEl.value.trim(),
            salary: Number(empSalaryEl.value) || 0
        };
        
        const list = loadEmployees();
        list.push(newEmployee);

        saveEmployees(list);
        employeeForm.reset();
        renderRH();
        empNameEl.focus();
    });

    $('#clearEmpBtn').addEventListener('click', ()=> employeeForm.reset());

    function removeEmployee(id){
        if(confirm("Tem certeza que deseja remover este funcion√°rio?")){
            const list = loadEmployees().filter(e => e.id !== id);
            saveEmployees(list);
            renderRH();
        }
    }

    function fulfillPayment(id) {
        const employee = loadEmployees().find(e => e.id === id);
        if (employee) {
            if (confirm(`Deseja registrar o pagamento de ${employee.name} e remover o alerta agendado?`)) {
                clearPaymentDate();
                renderRH(); 
            }
        }
    }

    $('#setPaymentDateBtn').addEventListener('click', () => {
        const current = loadPaymentDate();
        if (current) {
            scheduledPaymentDateEl.value = current;
        } else {
            const nextMonth = moment().add(1, 'month').startOf('month').format('YYYY-MM-DD');
            scheduledPaymentDateEl.value = nextMonth;
        }
        paymentModal.style.display = 'flex';
    });

    $('#closePaymentModal').addEventListener('click', () => {
        paymentModal.style.display = 'none';
    });

    paymentDateForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const date = scheduledPaymentDateEl.value;
        savePaymentDate(date);
        paymentModal.style.display = 'none';
        renderRH();
    });

    function updateRHNotification() {
        const scheduledDate = loadPaymentDate();
        const today = moment().startOf('day');
        
        rhBadge.classList.remove('active');
        paymentDateDisplay.textContent = 'N/A';
        
        if (scheduledDate) {
            const paymentDate = moment(scheduledDate, 'YYYY-MM-DD').startOf('day');

            paymentDateDisplay.textContent = paymentDate.format('DD/MM/YYYY');
            
            if (paymentDate.isSameOrBefore(today)) {
                rhBadge.classList.add('active');
            }
        }
    }

    function renderRH(){
        const employees = loadEmployees().sort((a,b)=> a.name.localeCompare(b.name));
        employeeTableBody.innerHTML = '';

        const showPaymentBtn = rhBadge.classList.contains('active');

        for(const emp of employees){
            const tr = document.createElement('tr');
            
            const btnHtml = showPaymentBtn 
                ? `<button class="payment-fulfilled-btn" data-id="${emp.id}" aria-label="Marcar pagamento de sal√°rio como cumprido">CUMPRIDO</button>`
                : `<span class="help">Aguardando vencimento</span>`;

            const paymentStatus = showPaymentBtn 
                ? `<span style="color: var(--danger); font-weight: 700;">PENDENTE</span>`
                : `<span style="color: var(--success);">OK</span>`;

            tr.innerHTML = `
                <td data-label="Nome:">${escapeHtml(emp.name)}</td>
                <td data-label="Cargo:">${escapeHtml(emp.role)}</td>
                <td data-label="Sal√°rio:">${formatBRL(emp.salary)}</td>
                <td data-label="Status:">${paymentStatus}</td>
                <td>
                    ${btnHtml}
                    <button data-id="${emp.id}" class="secondary danger" style="margin-top: 5px;" aria-label="Remover funcion√°rio">Remover</button>
                </td>
            `;

            if (showPaymentBtn) {
                tr.querySelector('.payment-fulfilled-btn').addEventListener('click', (e)=> fulfillPayment(Number(e.target.dataset.id)));
            }

            tr.querySelector('.danger').addEventListener('click', (e)=> removeEmployee(Number(e.target.dataset.id)));
            employeeTableBody.appendChild(tr);
        }
        
        updateRHNotification(); 
    }


    // ------------------------------------
    // L√ìGICA DE ESTOQUE (MANTIDA)
    // ------------------------------------
    function loadStock(){
        try{
            const raw = localStorage.getItem(STOCK_KEY);
            return raw ? JSON.parse(raw) : [];
        }catch(e){
            console.error('Erro ao carregar estoque', e);
            return [];
        }
    }
    function saveStock(list){
        localStorage.setItem(STOCK_KEY, JSON.stringify(list));
    }

    function calculateStockRisk() {
        const stocks = loadStock();
        const txs = loadTx().filter(t => t.type === 'credit'); 
        const daysToAnalyze = 28; 
        const analysisStartDate = moment().subtract(daysToAnalyze, 'days');
        
        const itemSales = {};

        txs.forEach(t => {
            const txDate = moment(t.date);
            if (txDate.isSameOrAfter(analysisStartDate)) {
                const code = t.category.trim().toUpperCase();
                const stockItemExists = stocks.some(s => s.code.toUpperCase() === code);
                if (stockItemExists) {
                    itemSales[code] = (itemSales[code] || 0) + 1;
                }
            }
        });

        const riskItems = [];
        
        stocks.forEach(item => {
            const code = item.code.toUpperCase();
            const salesCount = itemSales[code] || 0;
            const avgDailyConsumption = salesCount > 0 ? salesCount / daysToAnalyze : 0;
            
            if (avgDailyConsumption > 0 && item.quantity > 0) {
                const daysLeft = item.quantity / avgDailyConsumption;
                const isRisk = daysLeft <= 10; 
                
                if (isRisk) {
                    riskItems.push({
                        code: item.code,
                        name: item.name,
                        daysLeft: Math.ceil(daysLeft),
                        risk: isRisk
                    });
                }
            }
        });

        return riskItems.sort((a,b) => a.daysLeft - b.daysLeft);
    }
    
    function renderStock(){
        const filterText = $('#stockFilter').value.toLowerCase();
        let list = loadStock().sort((a,b)=> a.code.localeCompare(b.code));

        if (filterText) {
            list = list.filter(item => 
                item.code.toLowerCase().includes(filterText) ||
                item.name.toLowerCase().includes(filterText) ||
                item.category.toLowerCase().includes(filterText)
            );
        }

        $('#stockTable tbody').innerHTML = '';

        for(const item of list){
            const isLowStock = item.quantity < 5;
            const quantityClass = isLowStock ? 'low-stock' : '';
            const totalValue = item.price * item.quantity; 

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="C√≥d:">${escapeHtml(item.code)}</td>
                <td data-label="Produto:">${escapeHtml(item.name)}</td>
                <td data-label="Cat.:">${escapeHtml(item.category)}</td>
                <td data-label="Qtde:" class="${quantityClass}">${item.quantity}</td>
                <td data-label="Vlr Unit.:">${formatBRL(item.price)}</td>
                <td data-label="Vlr Total:" class="stock-total-value">${formatBRL(totalValue)}</td>
                <td><button data-code="${item.code}" aria-label="Remover item">Remover</button></td>
            `;
            tr.querySelector('button').addEventListener('click', (e)=> removeItem(e.target.dataset.code));
            $('#stockTable tbody').appendChild(tr);
        }
        
        const riskItems = calculateStockRisk();
        const container = $('#stockRiskAlerts');
        container.innerHTML = '';

        if (riskItems.length > 0) {
            const alertsHtml = riskItems.map(item => {
                const dayLabel = item.daysLeft === 1 ? 'dia' : 'dias';
                const dateRisk = moment().add(item.daysLeft, 'days').format('DD/MM/YYYY');
                return `<p class="help" style="color: var(--danger); font-weight: 600; margin-bottom: 4px; margin-top: 4px;">
                    ‚ö†Ô∏è Risco de esgotamento: Item '${item.name}' (C√≥d: ${item.code}) pode esgotar em ${item.daysLeft} ${dayLabel} (aprox. ${dateRisk}).
                </p>`;
            }).join('');
            container.innerHTML = alertsHtml;
        } else {
            container.innerHTML = `<p class="help" style="color: var(--success); font-weight: 600; margin-top: 4px;">‚úÖ Nenhum item est√° com risco de esgotamento nas pr√≥ximas 10 dias.</p>`;
        }
    }
    
    // ------------------------------------
    // L√ìGICA FINANCEIRA (MANTIDA)
    // ------------------------------------
    function loadTx(){
      try{
        const raw = localStorage.getItem(SALTO_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.error('Erro ao carregar dados financeiros', e);
        return [];
      }
    }
    function saveTx(list){
      localStorage.setItem(SALTO_KEY, JSON.stringify(list));
    }

    $('#clearBtn').addEventListener('click', ()=> txForm.reset());

    txForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const tx = {
        id: Date.now(),
        type: typeEl.value,
        date: dateEl.value || new Date().toISOString().slice(0,10),
        desc: descEl.value.trim() || '(sem descri√ß√£o)',
        category: catEl.value.trim() || 'Outros',
        amount: Number(amountEl.value) || 0
      };
      const list = loadTx();
      list.push(tx);
      saveTx(list);
      txForm.reset();
      render();
      typeEl.focus();
    });

    function removeTx(id){
      const list = loadTx().filter(t => t.id !== id);
      saveTx(list);
      render();
    }

    function formatBRL(v){
      return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    }

    function summarize(list){
      let saldo = 0, receitas = 0, despesas = 0;
      const last30 = new Date(); last30.setDate(last30.getDate()-30);
      let receitas30 = 0, despesas30 = 0;
      list.forEach(t => {
        if(t.type === 'credit'){
          saldo += t.amount; receitas += t.amount;
          if(new Date(t.date) >= last30) receitas30 += t.amount;
        }else{
          saldo -= t.amount; despesas += t.amount;
          if(new Date(t.date) >= last30) despesas30 += t.amount;
        }
      });
      return {saldo, receitas, despesas, receitas30, despesas30};
    }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    $('#exportBtn').addEventListener('click', ()=>{
      const list = loadTx();
      if(!list.length){ alert('N√£o h√° dados para exportar.'); return; }
      const header = ['id','date','type','description','category','amount'];
      const rows = list.map(r => [r.id, r.date, r.type, r.desc.replace(/\n/g,' '), r.category, r.amount]);
      const csv = [header, ...rows].map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `katalis-export-${new Date().toISOString().slice(0,10)}.csv`; 
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    const helpModal = $('#helpModal');
    $('#helpBtn').addEventListener('click', ()=> showHelp(true));
    $('#closeHelp').addEventListener('click', ()=> showHelp(false));
    function showHelp(show){
      helpModal.style.display = show ? 'flex' : 'none';
      helpModal.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    // --- L√ìGICA DAS ABAS (TABS) ---
    const tabLinks = qs('.tab-link');
    const tabPanes = qs('.tab-pane');

    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const targetId = e.target.getAttribute('data-tab-id');
            
            tabLinks.forEach(l => {
                l.classList.remove('active');
                l.setAttribute('aria-selected', 'false');
            });
            tabPanes.forEach(p => {
                p.style.display = 'none';
            });

            e.target.classList.add('active');
            e.target.setAttribute('aria-selected', 'true');
            $(`#${targetId}-content`).style.display = 'block';
            
            if (targetId === 'dashboard') {
                render(); 
                if(chart) chart.resize();
            } else if (targetId === 'stock') {
                renderStock();
            } else if (targetId === 'rh') {
                renderRH();
            } else if (targetId === 'todo') { // NOVO: Renderiza Tarefas
                renderTodo();
            }
        });
    });
    // --- FIM DA L√ìGICA DAS ABAS ---

    // --- Chart support ---
    let chart = null;

    function updateChart(list){
      const days = 30;
      let totalCredits = 0;
      let totalDebits = 0;

      const date30Days = new Date();
      date30Days.setDate(date30Days.getDate() - days);

      list.forEach(t => {
        if (new Date(t.date) >= date30Days) {
            if(t.type === 'credit') totalCredits += t.amount;
            else totalDebits += t.amount;
        }
      });

      const ctx = document.getElementById('summaryChart').getContext('2d');
      if(chart) chart.destroy(); 

      let chartConfig = {
        type: 'pie', 
        data: {
            labels: ['Receitas', 'Despesas'],
            datasets: [{
                data: [totalCredits, totalDebits],
                backgroundColor: ['rgba(22, 163, 74, 0.9)', 'rgba(220,38,38,0.8)'], 
                borderColor: ['#16a34a', 'rgba(220,38,38,1)']
            }]
        },
        options: {
          responsive:true, 
          maintainAspectRatio:false, 
          plugins:{
            legend:{position:'bottom'},
            tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed !== null) {
                      label += formatBRL(context.parsed);
                    }
                    return label;
                  }
                }
            }
          },
          scales: {}
        }
      };

      chart = new Chart(ctx, chartConfig);
    }

    function render(){
      const list = loadTx().sort((a,b)=> b.id - a.id);
      txTableBody.innerHTML = '';
      for(const t of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Data:">${t.date}</td>
          <td data-label="Desc.:">${escapeHtml(t.desc)}</td>
          <td data-label="Cat.:">${escapeHtml(t.category)}</td>
          <td data-label="Valor:" class="amount ${t.type==='credit'? 'credit':'debit'}">${t.type==='credit'?'+ ':'- '}${formatBRL(t.amount)}</td>
          <td><button data-id="${t.id}" aria-label="Remover transa√ß√£o">Remover</button></td>
        `;
        tr.querySelector('button').addEventListener('click', ()=> removeTx(t.id));
        txTableBody.appendChild(tr);
      }

      const s = summarize(list);
      $('#saldo').textContent = formatBRL(s.saldo);
      $('#receitas').textContent = formatBRL(s.receitas30 || 0);
      $('#despesas').textContent = formatBRL(s.despesas30 || 0);

      updateChart(list); 
    }
    
    // Inicializa o app
    render();
    renderStock();
    renderRH();
    renderTodo(); // Inicializa as Tarefas

    // Seta a data de hoje no campo de data por padr√£o
    dateEl.value = new Date().toISOString().slice(0,10);
  </script>
</body>
</html>
