<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drivor — Gerenciador Financeiro Simples</title>
  <meta name="description" content="Drivor: controle de receitas, despesas e relatório simples para pequenas empresas" />
  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#6b7280; --accent:#0f766e; --danger:#dc2626; --success:#16a34a;
      --radius:12px; --gap:16px; --maxw:1100px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: light;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#eef2f7); padding:32px; display:flex; justify-content:center; font-size:16px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{width:100%; max-width:var(--maxw)}

    header{display:flex; align-items:center; gap:16px; margin-bottom:20px}
    .logo{display:flex; align-items:center; gap:12px}
    .brand{font-weight:700; font-size:20px}
    .subtitle{color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns:1fr 360px; gap:var(--gap)}
    .card{background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:0 6px 20px rgba(2,6,23,0.06)}

    /* Dashboard */
    .balances{display:flex; gap:12px; margin-bottom:16px}
    .balance{flex:1; padding:14px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#fbfdfe); min-height:68px}
    .bal-title{font-size:12px; color:var(--muted)}
    .bal-value{font-weight:700; font-size:20px}
    
    /* Correção de Altura do Gráfico: Solução Definitiva */
    .chart-wrapper{
      /* Define uma altura absoluta para o contêiner. */
      height: 180px; 
      /* Adicionamos margem negativa para compensar o padding do .card e usar a largura total */
      margin-left: -18px;
      margin-right: -18px;
      padding: 0 18px;
    }
    #summaryChart{
      /* Garante que o canvas ocupe 100% da altura do wrapper pai (180px) */
      height: 100% !important; 
      width: 100% !important;
    }

    /* Form */
    label{display:block; font-size:13px; margin-bottom:8px}
    input[type="text"], input[type="number"], select, textarea, input[type="date"]{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ee; font-size:14px;
    }
    .row{display:flex; gap:12px}
    .row .col{flex:1}
    .actions{display:flex; gap:10px; margin-top:10px}
    button{background:var(--accent); color:white; border:0; padding:10px 12px; border-radius:8px; cursor:pointer}
    button.secondary{background:transparent; color:var(--accent); border:1px solid #cde7e2}
    button.danger{background:var(--danger)}

    /* Transactions */
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; text-align:left; border-bottom:1px solid #eef2f6}
    th{font-weight:600; font-size:13px; color:var(--muted)}
    .amount{font-weight:700}
    .credit{color:var(--success)}
    .debit{color:var(--danger)}

    /* Small screens */
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
      .balances{flex-direction:column}
      .chart-wrapper{
          margin-left: 0;
          margin-right: 0;
          padding: 0;
      }
    }

    /* a11y focus */
    :focus{outline:3px solid rgba(15,118,110,0.18); outline-offset:2px}

    /* Help text */
    .help{font-size:13px; color:var(--muted)}
    .compact{font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg width="44" height="44" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <rect width="24" height="24" rx="6" fill="#0f766e"></rect>
          <path d="M6 14l3-3 2 2 6-6" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
        <div>
          <div class="brand">Drivor</div>
          <div class="subtitle">Controle financeiro simples para pequenas empresas</div>
        </div>
      </div>
      <div style="margin-left:auto; display:flex; align-items:center; gap:12px">
        <button id="exportBtn" class="secondary" aria-label="Exportar dados">Exportar CSV</button>
        <button id="helpBtn" class="secondary" aria-label="Ajuda">Ajuda</button>
      </div>
    </header>

    <main class="grid" role="main">
      <section class="card" aria-labelledby="dashboardTitle">
        <h2 id="dashboardTitle">Visão geral</h2>
        <p class="help">Insira receitas e despesas pela direita. Os valores são guardados no navegador (localStorage).</p>

        <div class="balances" style="margin-top:12px">
          <div class="balance" aria-live="polite">
            <div class="bal-title">Saldo</div>
            <div id="saldo" class="bal-value">R$ 0,00</div>
          </div>
          <div class="balance">
            <div class="bal-title">Receitas (últimos 30 dias)</div>
            <div id="receitas" class="bal-value">R$ 0,00</div>
          </div>
          <div class="balance">
            <div class="bal-title">Despesas (últimos 30 dias)</div>
            <div id="despesas" class="bal-value">R$ 0,00</div>
          </div>
        </div>

        <div style="margin-top:16px" class="chart-wrapper">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding: 0 18px;">
            <h3 class="compact">Resumo financeiro</h3>
            <button id="toggleChart" class="secondary" aria-label="Alternar tipo de gráfico">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3v8H3M21 3v8h-8M3 21v-8h8M21 21v-8h-8"/>
              </svg>
            </button>
          </div>
          <canvas id="summaryChart" aria-label="Gráfico de receitas e despesas" role="img"></canvas>
        </div>

        <div style="margin-top:16px">
          <h3 class="compact">Últimas transações</h3>
          <div style="overflow:auto; max-height:260px; margin-top:8px">
            <table id="txTable" aria-live="polite">
              <thead>
                <tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Valor</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="card" aria-labelledby="formTitle">
        <h2 id="formTitle">Adicionar transação</h2>
        <form id="txForm">
          <label for="type">Tipo</label>
          <select id="type" required aria-required="true">
            <option value="credit">Receita</option>
            <option value="debit">Despesa</option>
          </select>

          <label for="date">Data</label>
          <input type="date" id="date" required />

          <label for="desc">Descrição</label>
          <input type="text" id="desc" placeholder="Ex: Venda, aluguel, compra de insumos" required />

          <label for="category">Categoria</label>
          <input type="text" id="category" placeholder="Ex: vendas, aluguel, suprimentos" />

          <label for="amount">Valor (R$)</label>
          <input type="number" id="amount" step="0.01" placeholder="0.00" required />

          <div class="actions">
            <button type="submit" aria-label="Salvar transação">Salvar</button>
            <button type="button" id="clearBtn" class="secondary">Limpar</button>
          </div>
        </form>

        <hr style="margin:14px 0" />

        <div>
          <h3 class="compact">Importante</h3>
          <p class="help">Use categorias simples e descreva as transações claramente. Para exportar os dados, clique em "Exportar CSV".</p>
          <p class="help" style="margin-top:8px">Os dados ficam apenas no seu navegador. Para backup, exporte o CSV regularmente.</p>
        </div>
      </aside>
    </main>

    <div id="helpModal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background-color: rgba(0,0,0,0.2);">
      <div class="card" style="width:95%; max-width:720px; box-shadow:0 10px 40px rgba(3,7,18,0.2)">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3>Ajuda — Como usar</h3>
          <button id="closeHelp" class="secondary">Fechar</button>
        </div>
        <div style="margin-top:8px">
          <ol>
            <li>Adicione <strong>Receita</strong> ou <strong>Despesa</strong> com data, descrição e valor.</li>
            <li>O saldo é calculado automaticamente. Use categorias para filtrar em futuras versões.</li>
            <li>Exportar CSV salva um arquivo que pode ser aberto no Excel ou Google Sheets.</li>
          </ol>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
  <script>
    // Configura o moment.js para o português, necessário para exibir os nomes dos meses
    moment.locale('pt-br'); 
    
    // --- Utilitários ---
    const $ = selector => document.querySelector(selector);
    const qs = selector => document.querySelectorAll(selector);

    // Form elements
    const txForm = $('#txForm');
    const typeEl = $('#type');
    const dateEl = $('#date');
    const descEl = $('#desc');
    const catEl = $('#category');
    const amountEl = $('#amount');
    const txTableBody = $('#txTable tbody');

    const SALTO_KEY = 'drivor_tx_v1';

    function loadTx(){
      try{
        const raw = localStorage.getItem(SALTO_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.error('Erro ao carregar dados', e);
        return [];
      }
    }
    function saveTx(list){
      localStorage.setItem(SALTO_KEY, JSON.stringify(list));
    }

    $('#clearBtn').addEventListener('click', ()=> txForm.reset());

    txForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const tx = {
        id: Date.now(),
        type: typeEl.value,
        date: dateEl.value || new Date().toISOString().slice(0,10),
        desc: descEl.value.trim() || '(sem descrição)',
        category: catEl.value.trim() || 'Outros',
        amount: Number(amountEl.value) || 0
      };
      const list = loadTx();
      list.push(tx);
      saveTx(list);
      txForm.reset();
      render();
      typeEl.focus();
    });

    function removeTx(id){
      const list = loadTx().filter(t => t.id !== id);
      saveTx(list);
      render();
    }

    function formatBRL(v){
      return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    }

    function summarize(list){
      let saldo = 0, receitas = 0, despesas = 0;
      const last30 = new Date(); last30.setDate(last30.getDate()-30);
      let receitas30 = 0, despesas30 = 0;
      list.forEach(t => {
        if(t.type === 'credit'){
          saldo += t.amount; receitas += t.amount;
          if(new Date(t.date) >= last30) receitas30 += t.amount;
        }else{
          saldo -= t.amount; despesas += t.amount;
          if(new Date(t.date) >= last30) despesas30 += t.amount;
        }
      });
      return {saldo, receitas, despesas, receitas30, despesas30};
    }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    $('#exportBtn').addEventListener('click', ()=>{
      const list = loadTx();
      if(!list.length){ alert('Não há dados para exportar.'); return; }
      const header = ['id','date','type','description','category','amount'];
      const rows = list.map(r => [r.id, r.date, r.type, r.desc.replace(/\n/g,' '), r.category, r.amount]);
      const csv = [header, ...rows].map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `drivor-export-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    const helpModal = $('#helpModal');
    $('#helpBtn').addEventListener('click', ()=> showHelp(true));
    $('#closeHelp').addEventListener('click', ()=> showHelp(false));
    function showHelp(show){
      helpModal.style.display = show ? 'flex' : 'none';
      helpModal.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    // --- Chart support ---
    let chart = null;
    const chartTypes = ['bar','line','pie']; // Tipos de gráfico disponíveis
    let currentChartIndex = 0; // Índice do tipo de gráfico atual

    function updateChart(list){
      // Para mostrar meses, vamos usar todos os dados em vez de apenas os últimos 30 dias para o eixo X.
      // E para o gráfico, vamos focar nos últimos 30 dias para os valores (receitas/despesas).
      const days = 30;
      const map = {};
      const datesToProcess = [];

      // 1. Coletar todas as datas únicas de transações para o eixo X
      list.forEach(t => {
          if (!datesToProcess.includes(t.date)) {
              datesToProcess.push(t.date);
          }
      });
      datesToProcess.sort();
      
      // 2. Preencher o mapa de dados apenas para os últimos 30 dias para a visualização
      for(let i=days-1;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate()-i);
        const key = d.toISOString().slice(0,10);
        map[key] = {credit:0, debit:0};
      }
      
      list.forEach(t => {
        // Filtrar transações apenas dos últimos 30 dias para o gráfico (para consistência)
        const date30Days = new Date();
        date30Days.setDate(date30Days.getDate() - days);
        if (new Date(t.date) >= date30Days) {
            if(map[t.date]){
              if(t.type === 'credit') map[t.date].credit += t.amount;
              else map[t.date].debit += t.amount;
            }
        }
      });
      
      // Se não houver dados nos últimos 30 dias, use todas as datas únicas para o eixo
      // mas os valores do gráfico (credits/debits) serão 0
      const labels = Object.keys(map).sort(); // Datas dos últimos 30 dias
      const credits = labels.map(l => map[l].credit);
      const debits = labels.map(l => map[l].debit);
      
      // === NOVO: Lógica para Gráfico de Meses ===
      const firstDate = labels[0];
      const lastDate = labels[labels.length - 1];

      const ctx = document.getElementById('summaryChart').getContext('2d');
      if(chart) chart.destroy(); // Destruir o gráfico anterior antes de criar um novo

      const currentType = chartTypes[currentChartIndex];

      let chartConfig = {
        type: currentType,
        data: {
          // Os labels precisam ser datas (strings YYYY-MM-DD) para o adapter funcionar
          labels: labels, 
          datasets: [
            {label:'Receitas', data:credits, backgroundColor:'rgba(16,118,110,0.8)', borderColor:'rgba(16,118,110,1)', fill:false},
            {label:'Despesas', data:debits, backgroundColor:'rgba(220,38,38,0.8)', borderColor:'rgba(220,38,38,1)', fill:false}
          ]
        },
        options: {
          responsive:true, 
          maintainAspectRatio:false, 
          plugins:{
            legend:{position:'bottom'},
            tooltip: { // Configurações para o Tooltip
                callbacks: {
                    title: function(tooltipItems) {
                        // Formata a data para Mês/Ano no Tooltip
                        return moment(tooltipItems[0].label).format('MMM YYYY');
                    }
                }
            }
          },
          scales: currentType === 'pie' ? {} : {
            x: {
              type: 'time',
              time: {
                unit: 'month', // <--- Principal mudança: Mudar a unidade de exibição para MÊS
                displayFormats: {
                    month: 'MMM YYYY' // Formato: Set 2025
                },
                tooltipFormat: 'MMM YYYY'
              },
              // Força o início e o fim do eixo para os dados de 30 dias
              min: firstDate,
              max: lastDate,
              ticks: {
                source: 'labels',
                autoSkip: true,
                maxRotation: 0,
                minRotation: 0,
                callback: function(value, index, values) {
                    // Lógica para mostrar só um mês se for o caso:
                    // Verifica se o próximo ponto é em outro mês. 
                    // Se não for, não exibe. Isso simula o agrupamento.
                    if (index === 0) return moment(value).format('MMM');
                    const currentMonth = moment(value).format('YYYY-MM');
                    const prevMonth = moment(values[index-1].value).format('YYYY-MM');
                    if (currentMonth !== prevMonth) {
                        return moment(value).format('MMM');
                    }
                    return null; // Oculta a data
                }
              }
            }, 
            y: {display:true}
          }
        }
      };

      // Lógica específica para Gráfico de Pizza (Pie Chart) - INTACTA
      if (currentType === 'pie') {
          // ... (mesma lógica) ...
          const totalCredits = credits.reduce((sum, val) => sum + val, 0);
          const totalDebits = debits.reduce((sum, val) => sum + val, 0);

          chartConfig.data = {
              labels: ['Receitas', 'Despesas'],
              datasets: [{
                  data: [totalCredits, totalDebits],
                  backgroundColor: ['rgba(16,118,110,0.8)', 'rgba(220,38,38,0.8)'],
                  borderColor: ['rgba(16,118,110,1)', 'rgba(220,38,38,1)']
              }]
          };
          chartConfig.options.plugins.tooltip = {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed !== null) {
                  label += formatBRL(context.parsed);
                }
                return label;
              }
            }
          };
          // Gráfico de pizza não precisa de escala X
          chartConfig.options.scales = {};
      }

      chart = new Chart(ctx, chartConfig);
    }

    document.getElementById('toggleChart').addEventListener('click', ()=>{
      currentChartIndex = (currentChartIndex + 1) % chartTypes.length; // Avança para o próximo tipo
      render(); // Redesenha a interface
    });
    
    function render(){
      const list = loadTx().sort((a,b)=> b.id - a.id);
      txTableBody.innerHTML = '';
      for(const t of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.date}</td>
          <td>${escapeHtml(t.desc)}</td>
          <td>${escapeHtml(t.category)}</td>
          <td class="amount ${t.type==='credit'? 'credit':'debit'}">${t.type==='credit'?'+ ':'- '}${formatBRL(t.amount)}</td>
          <td><button data-id="${t.id}" aria-label="Remover transação">Remover</button></td>
        `;
        tr.querySelector('button').addEventListener('click', ()=> removeTx(t.id));
        txTableBody.appendChild(tr);
      }

      const s = summarize(list);
      $('#saldo').textContent = formatBRL(s.saldo);
      $('#receitas').textContent = formatBRL(s.receitas30 || 0);
      $('#despesas').textContent = formatBRL(s.despesas30 || 0);

      updateChart(list); // Chama a função do gráfico
    }

    // Inicializa o app
    render();

    // Seta a data de hoje no campo de data por padrão
    dateEl.value = new Date().toISOString().slice(0,10);
  </script>
</body>
</html>
